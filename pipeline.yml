trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'ubuntu-latest'

#set needed vairables
variables:
  azureServicePrincipalId: $(azureServicePrincipalId)
  azureServicePrincipalKey: $(azureServicePrincipalKey)
  azureTenantId: $(azureTenantId)
  azureSubscriptionId: $(azureSubscriptionId)
  keyVaultName: $(keyVaultName)

steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: 'AzureServiceConnection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      curl -O https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
      unzip terraform_1.5.0_linux_amd64.zip
      sudo mv terraform /usr/local/bin/
      terraform -v

- script: |
    terraform init

    terraform plan -var-file=terraform.tfvars

    terraform apply -auto-approve -var-file=terraform.tfvars

  displayName: 'Terraform Init, Plan and Apply'